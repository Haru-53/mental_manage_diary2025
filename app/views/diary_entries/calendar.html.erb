<div class="container mt-4">
  <h1>カレンダー</h1>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <%= link_to "前月", calendar_diary_entries_path(date: @date.prev_month), class: "btn btn-outline-secondary" %>
    <h2 class="mb-0"><%= l(@date, format: '%Y年%m月') %></h2>
    <%= link_to "次月", calendar_diary_entries_path(date: @date.next_month), class: "btn btn-outline-secondary" %>
  </div>

  <div class="mb-3">
    <%= link_to "日記一覧", diary_entries_path, class: "btn btn-primary" %>
    <%= link_to "新規作成", new_diary_entry_path, class: "btn btn-success" %>
    <%= link_to "幸福度定義", happiness_items_path, class: "btn btn-info" %>
  </div>

  <table class="table table-bordered calendar-table">
    <thead>
      <tr>
        <% I18n.t('date.abbr_day_names').each do |day| %>
          <th><%= day %></th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% date_range = (@date.beginning_of_month.beginning_of_week..@date.end_of_month.end_of_week).to_a %>
      <% date_range.each_slice(7) do |week| %>
        <tr>
          <% week.each do |day| %>
            <% 
              diary_entry = @diary_entries.find { |entry| entry.date.to_date == day }
              today_class = day == Date.today ? 'today' : ''
              month_class = day.month == @date.month ? 'current-month' : 'other-month'
              happiness_class = diary_entry ? "happiness-#{diary_entry.happiness_score || 0}" : ''
              
              # 編集した日付をハイライト
              highlight_class = ''
              if params[:date] && day.to_s == params[:date].to_date.to_s
                highlight_class = 'highlight-date'
              end
            %>
            <td class="<%= [today_class, month_class, happiness_class, highlight_class].join(' ') %>">
              <div class="date-number"><%= day.day %></div>
              
              <% if diary_entry %>
                <div class="diary-indicator">
                  <%= link_to diary_entry_path(diary_entry) do %>
                    <i class="fas fa-check"></i>
                    <span class="happiness-dot" style="background-color: <%= happiness_dot_color(diary_entry.happiness_score) %>;"></span>
                    <small><%= truncate(diary_entry.title, length: 10) %></small>
                  <% end %>
                </div>
              <% else %>
                <%= link_to "+", new_diary_entry_path(diary_entry: { date: day }), class: "add-entry-link" if day.month == @date.month %>
              <% end %>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<style>
  .calendar-table td {
    height: 100px;
    width: 14.28%;
    vertical-align: top;
    padding: 5px;
    position: relative;
  }
  
  .today {
    background-color: #f8f9fa;
    border: 2px solid #007bff !important;
  }
  
  .other-month {
    background-color: #f0f0f0;
    color: #999;
  }
  
  .date-number {
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .diary-indicator {
    margin-top: 5px;
  }
  
  .add-entry-link {
    position: absolute;
    bottom: 5px;
    right: 5px;
    color: #6c757d;
    font-size: 16px;
  }

  .happiness-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 3px;
  }
  
  /* 編集した日付のハイライト */
  .highlight-date {
    animation: pulse 2s infinite;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
  }
  
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
    }
  }
</style>
